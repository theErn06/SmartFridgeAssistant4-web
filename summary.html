<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jarvis Smart Fridge - Summary</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
    />
  </head>
  <body>
    <div id="dashboard-wrapper">
      <div class="sidebar-overlay" onclick="toggleMenu()"></div>
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo-area">
            <div class="header-icon">â„ï¸</div>
            <span class="header-text">Jarvis OS</span>
          </div>
          <button class="close-btn" onclick="toggleMenu()">Ã—</button>
        </div>
        <div class="nav-links">
          <a class="nav-item" href="inventory.html"
            ><div class="icon-box">ğŸ“¦</div>
            <span class="nav-text">Inventory</span></a
          >
          <a class="nav-item active" href="summary.html"
            ><div class="icon-box">ğŸ“Š</div>
            <span class="nav-text">Summary</span></a
          >
          <a class="nav-item" href="guide.html"
            ><div class="icon-box">ğŸ“–</div>
            <span class="nav-text">Guide</span></a
          >
          <a class="nav-item" href="about.html"
            ><div class="icon-box">ğŸ‘¨â€ğŸ’»</div>
            <span class="nav-text">About Us</span></a
          >
          <a class="nav-item" href="jarvis.html"
            ><div class="icon-box">ğŸ¤–</div>
            <span class="nav-text">Jarvis</span></a
          >
        </div>
        <div class="bottom-section" id="logout-section">
          <a class="nav-item logout-item" onclick="logout()"
            ><div class="icon-box">ğŸšª</div>
            <span class="nav-text">Logout</span></a
          >
        </div>
      </div>

      <div class="main-content">
        <div class="mobile-header">
          <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
          <span class="logo-text">Jarvis OS</span>
        </div>
        <div class="content-wrapper animate-fade-in">
          <h2 class="page-title">Waste Summary</h2>

          <div
            style="
              background-color: #fff3f3;
              padding: 20px;
              border-radius: 8px;
              margin-bottom: 25px;
              border-left: 5px solid #e74c3c;
            "
          >
            <h3
              style="
                margin: 0;
                color: #2c3e50;
                font-size: 16px;
                font-weight: 600;
              "
            >
              ğŸš¨ You wasted
              <span
                id="weekly-waste-count"
                style="color: #e74c3c; font-weight: bold"
                >0</span
              >
              items last 7 days and
              <span
                id="monthly-waste-count"
                style="color: #e74c3c; font-weight: bold"
                >0</span
              >
              items last 30 days.
            </h3>
          </div>

          <h2
            style="
              color: #e74c3c;
              font-size: 18px;
              border-bottom: 2px solid #eee;
              padding-bottom: 10px;
            "
          >
            Weekly Waste Report
          </h2>
          <div class="table-responsive" style="margin-bottom: 40px">
            <table id="weekly-table" class="display" style="width: 100%">
              <thead>
                <tr>
                  <th>Event Date</th>
                  <th>Item</th>
                  <th>Qty</th>
                  <th>Unit</th>
                  <th>Status</th>
                </tr>
              </thead>
            </table>
          </div>

          <h2
            style="
              color: #e74c3c;
              font-size: 18px;
              border-bottom: 2px solid #eee;
              padding-bottom: 10px;
            "
          >
            Monthly Waste Report
          </h2>
          <div class="table-responsive">
            <table id="monthly-table" class="display" style="width: 100%">
              <thead>
                <tr>
                  <th>Event Date</th>
                  <th>Item</th>
                  <th>Qty</th>
                  <th>Unit</th>
                  <th>Status</th>
                </tr>
              </thead>
            </table>
          </div>
          <div
            style="
              text-align: center;
              padding: 20px;
              color: #7f8c8d;
              font-size: 14px;
              margin-top: auto;
            "
          >
            Version 4
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwR3LH7qkeNNNZgEhOSMFqXZcO9xyVF7DiQau7gDxcTJ6ljtgD4EwrIm8tmC-B-fMpMag/exec";
      let currentUser = sessionStorage.getItem("currentUser");
      let currentPass = sessionStorage.getItem("currentPass");

      if (!currentUser) window.location.href = "index.html";

      $(document).ready(function () {
        loadSummaryTables();
      });

      function toggleMenu() {
        $("#sidebar").toggleClass("open");
        $(".sidebar-overlay").toggleClass("open");
      }

      function logout() {
        sessionStorage.clear();
        window.location.href = "index.html";
      }

      function loadSummaryTables() {
        $.ajax({
          url: API_URL,
          method: "POST",
          contentType: "text/plain",
          data: JSON.stringify({
            action: "get_summaries",
            username: currentUser,
            password: currentPass,
          }),
          success: function (response) {
            let json;
            try {
              json =
                typeof response === "object" ? response : JSON.parse(response);
            } catch (e) {
              json = { status: "error" };
            }

            if (json.status === "success") {
              let weeklyTotal = (json.weekly || []).reduce(
                (sum, item) => sum + (Number(item.qty) || 0),
                0,
              );
              let monthlyTotal = (json.monthly || []).reduce(
                (sum, item) => sum + (Number(item.qty) || 0),
                0,
              );

              $("#weekly-waste-count").text(
                Number.isInteger(weeklyTotal)
                  ? weeklyTotal
                  : weeklyTotal.toFixed(1),
              );
              $("#monthly-waste-count").text(
                Number.isInteger(monthlyTotal)
                  ? monthlyTotal
                  : monthlyTotal.toFixed(1),
              );

              initSummaryTable("#weekly-table", json.weekly || []);
              initSummaryTable("#monthly-table", json.monthly || []);
            }
          },
        });
      }

      function initSummaryTable(tableId, data) {
        if ($.fn.DataTable.isDataTable(tableId)) {
          let dt = $(tableId).DataTable();
          dt.clear();
          dt.rows.add(data);
          dt.draw();
        } else {
          $(tableId).DataTable({
            data: data,
            columns: [
              {
                data: "date_event",
                defaultContent: "-",
                render: (d) =>
                  d === "N/A" || d === "-"
                    ? "N/A"
                    : moment(d).format("YYYY-MM-DD"),
              },
              {
                data: "item",
                defaultContent: "-",
                render: (d) =>
                  String(d).charAt(0).toUpperCase() + String(d).slice(1),
              },
              { data: "qty", defaultContent: "0" },
              {
                data: "unit",
                defaultContent: "-",
                render: (d) =>
                  String(d).charAt(0).toUpperCase() + String(d).slice(1),
              },
              {
                data: "status",
                defaultContent: "EXPIRED",
                render: function (data) {
                  return `<span style="color: #e74c3c; font-weight: bold;">${data}</span>`;
                },
              },
            ],
            order: [[0, "desc"]],
          });
        }
      }
    </script>
  </body>
</html>
