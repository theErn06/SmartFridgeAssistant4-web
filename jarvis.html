<!doctype html>
<html>
  <head>
    <title>Jarvis Smart Fridge - Jarvis AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; color: #333; }
      @media (min-width: 769px) { body { zoom: 110%; } }
      #dashboard-wrapper { display: flex; height: 100vh; overflow: hidden; }
      .sidebar { width: 250px; min-width: 250px; flex-shrink: 0; background: #2c3e50; color: white; height: 100vh; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 1000; }
      .sidebar-header { padding: 20px; font-size: 20px; font-weight: bold; background: #1a252f; text-align: center; border-bottom: 1px solid #34495e; }
      .sidebar-menu { display: flex; flex-direction: column; padding-top: 10px; flex-grow: 1; }
      .sidebar-menu a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: #ecf0f1; display: block; transition: 0.2s; border-left: 4px solid transparent; cursor: pointer; }
      .sidebar-menu a:hover { background: #34495e; }
      .sidebar-menu a.active { background: #34495e; border-left-color: #3498db; font-weight: bold; }
      .main-content { flex-grow: 1; height: 100vh; overflow-y: auto; background-color: #f8f9fa; display: flex; flex-direction: column; }
      .topbar { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
      .menu-toggle { font-size: 24px; cursor: pointer; display: none; background: none; border: none; color: #2c3e50; padding: 0; margin-right: 15px; }
      .topbar-left { display: flex; align-items: center; }
      .topbar-title { margin: 0; font-size: 18px; color: #2c3e50; font-weight: 600; }
      .danger-btn { background-color: #dc3545; width: auto; padding: 8px 15px; margin: 0; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
      .danger-btn:hover { background-color: #c82333; }
      .content-container { padding: 25px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
      .dashboard-view { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); animation: fadeIn 0.4s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; }
      
      .info-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
      .info-card h3 { margin-top: 0; color: #2c3e50; font-size: 20px; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
      
      input[type="text"] { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
      button { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
      button:hover { background-color: #0056b3; }
      
      .network-bar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
      .btn-scan { background-color: #28a745; margin: 0; }
      .btn-scan:hover { background-color: #218838; }

      .btn-mic { background-color: #28a745; font-size: 18px; padding: 10px 15px; }
      .btn-mic:hover { background-color: #218838; }
      .btn-mic.recording { background-color: #dc3545; animation: pulse 1s infinite; }
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
      
      @media (max-width: 768px) {
        .sidebar { position: fixed; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .menu-toggle { display: block; }
        .sidebar-overlay.open { display: block; }
        .content-container { padding: 15px; }
        .dashboard-view { padding: 15px; }
      }
    </style>
  </head>
  <body>
    <div id="dashboard-wrapper">
      <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">Jarvis OS</div>
        <div class="sidebar-menu">
          <a class="nav-link" href="inventory.html">üì¶ Inventory</a>
          <a class="nav-link" href="summary.html">üìä Summary</a>
          <a class="nav-link" href="guide.html">üìñ Guide</a>
          <a class="nav-link" href="about.html">üë®‚Äçüíª About Us</a>
          <a class="nav-link active" href="jarvis.html">ü§ñ Jarvis</a>
        </div>
      </div>

      <div class="main-content">
        <div class="topbar">
          <div class="topbar-left">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <h2 class="topbar-title" id="page-title">Jarvis Remote Console</h2>
          </div>
          <button class="danger-btn" onclick="logout()">Logout</button>
        </div>

        <div class="content-container">
          <div id="jarvis-tab" class="dashboard-view">
            
            <div class="info-card" style="padding-bottom: 20px;">
              <h3>Network Configuration</h3>
              <p style="margin-top: 0; font-size: 14px; color: #666;">Ensure your laptop and phone are on the same Wi-Fi.</p>
              
              <div class="network-bar">
                <input type="text" id="jarvis-ip" value="localhost" placeholder="Server IP" style="width: 160px; margin: 0;">
                <span style="color: #666; font-size: 14px; font-weight: bold;">: 5000</span>
                <button class="btn-scan" id="scan-btn" onclick="scanNetwork()">üì° Auto-Detect Wi-Fi</button>
              </div>
            </div>

            <div class="info-card" style="height: 500px; display: flex; flex-direction: column;">
              <h3 style="margin-bottom: 15px;">Live Chat</h3>
              
              <div id="chat-box" style="flex-grow: 1; overflow-y: auto; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; flex-direction: column;">
                <div style="text-align: left; margin-bottom: 10px;">
                    <div style="display: inline-block; background: #e9ecef; color: black; padding: 10px 15px; border-radius: 15px; max-width: 80%;">
                      <strong style="font-size: 12px; display: block; margin-bottom: 3px; color: #555;">Jarvis</strong>
                      System online. Testing connection...
                    </div>
                </div>
              </div>

              <div style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Type a command (e.g. Add two milks)..." style="flex-grow: 1; margin: 0;" onkeypress="handleEnter(event)">
                <button class="btn-mic" id="mic-btn" onclick="toggleVoice()" title="Tap to Speak">üé§</button>
                <button id="send-btn" onclick="sendCommand()" style="width: 100px; margin: 0;">Send</button>
              </div>
            </div>

          </div>
        </div>
        
        <div style="text-align: center; padding: 20px; color: #7f8c8d; font-size: 14px; margin-top: auto;">Version 4</div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script>
      let currentUser = sessionStorage.getItem("currentUser");
      if (!currentUser) window.location.href = "login.html";

      $(document).ready(function() {
          // --- AUTO CONNECT ON PAGE LOAD ---
          // Attempt to load the last known working IP from storage, otherwise fallback to the box value
          let savedIp = localStorage.getItem("jarvisIp") || $('#jarvis-ip').val();
          $('#jarvis-ip').val(savedIp);
          
          testAndConnect(savedIp);
      });

      function toggleSidebar() { $("#sidebar, .sidebar-overlay").toggleClass("open"); }
      function logout() { sessionStorage.clear(); window.location.href = "login.html"; }

      function appendMsg(sender, text) {
        let align = sender === 'You' ? 'flex-end' : 'flex-start';
        let bg = sender === 'You' ? '#007bff' : '#e9ecef';
        let color = sender === 'You' ? 'white' : 'black';
        let html = `
          <div style="align-self: ${align}; margin-bottom: 10px; max-width: 80%;">
            <div style="display: inline-block; background: ${bg}; color: ${color}; padding: 10px 15px; border-radius: 15px;">
              <strong style="font-size: 12px; display: block; margin-bottom: 3px; opacity: 0.8;">${sender}</strong>
              ${text}
            </div>
          </div>`;
        $('#chat-box').append(html);
        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
      }

      function handleEnter(e) { if (e.key === 'Enter') sendCommand(); }

      function testAndConnect(ip) {
          if (!ip || ip === "localhost") {
              scanNetwork();
              return;
          }

          $.ajax({
              url: `http://${ip}:5000/ping`,
              method: 'GET',
              timeout: 1500,
              success: function() {
                  appendMsg("System", `‚úÖ <strong>Connected!</strong> Linked to PC at ${ip}`);
                  localStorage.setItem("jarvisIp", ip); 
              },
              error: function() {
                  appendMsg("System", `‚ö†Ô∏è Last known IP (${ip}) offline. Starting auto-scan...`);
                  scanNetwork();
              }
          });
      }

      function scanNetwork() {
          $('#scan-btn').text("Scanning...").prop("disabled", true);
          appendMsg("System", "üì° <i>Scanning local Wi-Fi for your PC...</i>");
          
          let subnets = ['192.168.1.', '192.168.0.', '192.168.100.', '10.0.0.'];
          let found = false;
          
          for (let prefix of subnets) {
              for (let i = 2; i <= 254; i++) {
                  if (found) break;
                  let testIp = prefix + i;
                  
                  $.ajax({
                      url: `http://${testIp}:5000/ping`,
                      method: 'GET',
                      timeout: 3000,
                      success: function() {
                          if (!found) {
                              found = true;
                              $('#jarvis-ip').val(testIp);
                              localStorage.setItem("jarvisIp", testIp);
                              appendMsg("System", `‚úÖ <strong>Success!</strong> Auto-connected to ${testIp}`);
                              $('#scan-btn').text("üì° Auto-Detect Wi-Fi").prop("disabled", false);
                          }
                      }
                  });
              }
          }

          setTimeout(() => {
              if (!found) {
                  appendMsg("System", "‚ùå Scan finished. Could not find Jarvis. Make sure your PC is on the same Wi-Fi and Python is running.");
                  $('#scan-btn').text("üì° Auto-Detect Wi-Fi").prop("disabled", false);
              }
          }, 3500);
      }

      function sendCommand() {
        let input = $('#chat-input').val().trim();
        if (!input) return;

        appendMsg("You", input);
        $('#chat-input').val("");
        $('#send-btn').prop('disabled', true).text("...");

        let ip = $('#jarvis-ip').val().trim() || "localhost";

        $.ajax({
          url: `http://${ip}:5000/command`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ command: input }),
          timeout: 60000, 
          success: function (res) {
            $('#send-btn').prop('disabled', false).text("Send");
            if (res.status === "success") appendMsg("Jarvis", res.reply || "Done.");
            else appendMsg("Jarvis", "‚ö†Ô∏è Processing Error.");
          },
          error: function (xhr, status, error) {
            $('#send-btn').prop('disabled', false).text("Send");
            appendMsg("System", `‚ö†Ô∏è Connection failed. Try clicking 'Auto-Detect Wi-Fi'.`);
          }
        });
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition = null;
      let isRecording = false;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
            let transcript = event.results[0][0].transcript;
            $('#chat-input').val(transcript);
            stopRecordingUI();
            sendCommand(); 
        };

        recognition.onerror = function(event) {
            console.error(event.error);
            stopRecordingUI();
            alert("Microphone error: " + event.error);
        };

        recognition.onend = function() { stopRecordingUI(); };
      } else {
        $('#mic-btn').hide(); 
      }

      function toggleVoice() {
        if (!recognition) return alert("Speech recognition not supported in this browser.");
        if (isRecording) {
            recognition.stop();
            stopRecordingUI();
        } else {
            recognition.start();
            $('#mic-btn').addClass('recording').text("‚èπ");
            $('#chat-input').val("Listening...");
            isRecording = true;
        }
      }

      function stopRecordingUI() {
          $('#mic-btn').removeClass('recording').text("üé§");
          if($('#chat-input').val() === "Listening...") $('#chat-input').val("");
          isRecording = false;
      }
    </script>
  </body>
</html>
