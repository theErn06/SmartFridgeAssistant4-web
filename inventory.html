<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jarvis Smart Fridge - Inventory</title>
    <link rel="icon" type="image/jpeg" href="jarvis-icon.jpg" />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
    />
  </head>
  <body>
    <div id="dashboard-wrapper">
      <div class="sidebar-overlay" onclick="toggleMenu()"></div>

      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo-area">
            <div class="header-icon">‚ùÑÔ∏è</div>
            <span class="header-text">Jarvis OS</span>
          </div>
          <button class="close-btn" onclick="toggleMenu()">√ó</button>
        </div>
        <div class="nav-links">
          <a class="nav-item active" href="inventory.html"
            ><div class="icon-box">üì¶</div>
            <span class="nav-text">Inventory</span></a
          >
          <a class="nav-item" href="summary.html"
            ><div class="icon-box">üìä</div>
            <span class="nav-text">Summary</span></a
          >
          <a class="nav-item" href="guide.html"
            ><div class="icon-box">üìñ</div>
            <span class="nav-text">Guide</span></a
          >
          <a class="nav-item" href="about.html"
            ><div class="icon-box">üë®‚Äçüíª</div>
            <span class="nav-text">About Us</span></a
          >
          <a class="nav-item" href="#" onclick="openJarvisTab(event)">
            <div class="icon-box">ü§ñ</div>
            <span class="nav-text">Jarvis</span>
          </a>
        </div>
        <div class="bottom-section" id="logout-section">
          <a class="nav-item logout-item" onclick="logout()"
            ><div class="icon-box">üö™</div>
            <span class="nav-text">Logout</span></a
          >
        </div>
      </div>

      <div class="main-content">
        <div class="mobile-header">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <span class="logo-text">Jarvis OS</span>
        </div>

        <div class="content-wrapper animate-fade-in">
          <h2 class="page-title">Live Inventory</h2>

          <div class="mobile-controls">
            <div class="mobile-search-box">
              <input
                type="text"
                id="mobile-search-input"
                placeholder="Search inventory..."
              />
            </div>
            <div class="mobile-sort-box">
              <select id="mobile-sort-select">
                <option value="0_asc">Name (A-Z)</option>
                <option value="1_desc">Highest Qty</option>
                <option value="6_asc">Expiring Soon</option>
              </select>
            </div>
          </div>

          <div
            style="
              background-color: #fff3f3;
              padding: 20px;
              border-radius: 8px;
              margin-bottom: 25px;
              border-left: 5px solid #e74c3c;
            "
          >
            <h3
              style="
                margin: 0;
                color: #2c3e50;
                font-size: 16px;
                font-weight: 600;
              "
            >
              üö® You wasted
              <span
                id="weekly-waste-count"
                style="color: #e74c3c; font-weight: bold"
                >0</span
              >
              items last 7 days and
              <span
                id="monthly-waste-count"
                style="color: #e74c3c; font-weight: bold"
                >0</span
              >
              items last 30 days.
            </h3>
          </div>

          <div class="table-responsive">
            <table id="inventory" class="display" style="width: 100%">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Qty</th>
                  <th>Unit</th>
                  <th>Category</th>
                  <th>Expiry</th>
                  <th>Status</th>
                  <th>Days Left</th>
                </tr>
              </thead>
            </table>
          </div>
          <div
            style="
              text-align: center;
              padding: 20px;
              color: #7f8c8d;
              font-size: 14px;
              margin-top: auto;
            "
          >
            Version 4
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwR3LH7qkeNNNZgEhOSMFqXZcO9xyVF7DiQau7gDxcTJ6ljtgD4EwrIm8tmC-B-fMpMag/exec";
      let currentUser = sessionStorage.getItem("currentUser");
      let currentPass = sessionStorage.getItem("currentPass");

      if (!currentUser) window.location.href = "index.html";

      $(document).ready(function () {
        loadTable();
        loadWasteCounts();
      });

      function toggleMenu() {
        $("#sidebar").toggleClass("open");
        $(".sidebar-overlay").toggleClass("open");
      }

      function logout() {
        sessionStorage.clear();
        window.location.href = "index.html";
      }

      function openJarvisTab(e) {
        e.preventDefault();
        let currentHost = window.location.hostname;

        // If you are using your laptop and are already on localhost, open normally in same tab
        if (
          currentHost === "localhost" ||
          currentHost === "127.0.0.1" ||
          /^(192\.168|10\.|172\.)/.test(currentHost)
        ) {
          window.location.href = "jarvis.html";
          return;
        }

        // If you are on GitHub, Prompt the user and open a NEW tab directly to the IP
        let savedIp = localStorage.getItem("jarvis_ip");
        let targetIp = prompt(
          "Jarvis Direct Link:\n\nEnter the IP address shown on the Arduino Display (e.g., 192.168.1.10):",
          savedIp || "",
        );

        if (targetIp) {
          targetIp = targetIp.trim();
          localStorage.setItem("jarvis_ip", targetIp);
          // Opens http://192.168.x.x:5000/jarvis.html in a fresh browser tab!
          window.open(`http://${targetIp}:5000/jarvis.html`, "_blank");
        }
      }

      function loadWasteCounts() {
        $.ajax({
          url: API_URL,
          method: "POST",
          contentType: "text/plain",
          data: JSON.stringify({
            action: "get_summaries",
            username: currentUser,
            password: currentPass,
          }),
          success: function (response) {
            let json;
            try {
              json =
                typeof response === "object" ? response : JSON.parse(response);
            } catch (e) {
              json = { status: "error" };
            }

            if (json.status === "success") {
              let weeklyTotal = (json.weekly || []).reduce(
                (sum, item) => sum + (Number(item.qty) || 0),
                0,
              );
              let monthlyTotal = (json.monthly || []).reduce(
                (sum, item) => sum + (Number(item.qty) || 0),
                0,
              );
              $("#weekly-waste-count").text(
                Number.isInteger(weeklyTotal)
                  ? weeklyTotal
                  : weeklyTotal.toFixed(1),
              );
              $("#monthly-waste-count").text(
                Number.isInteger(monthlyTotal)
                  ? monthlyTotal
                  : monthlyTotal.toFixed(1),
              );
            }
          },
        });
      }

      function loadTable() {
        if ($.fn.DataTable.isDataTable("#inventory")) {
          $("#inventory").DataTable().ajax.reload(null, false);
          return;
        }

        $("#inventory").DataTable({
          processing: true,
          ajax: function (data, callback, settings) {
            $.ajax({
              url: API_URL,
              method: "POST",
              contentType: "text/plain",
              data: JSON.stringify({
                action: "get_inventory",
                username: currentUser,
                password: currentPass,
              }),
              success: function (response) {
                let json;
                try {
                  json =
                    typeof response === "object"
                      ? response
                      : JSON.parse(response);
                } catch (e) {
                  json = { data: [] };
                }
                if (json.error) {
                  alert(json.error);
                  logout();
                } else {
                  callback({ data: json.data || [] });
                }
              },
              error: function () {
                alert("Failed to load inventory.");
                callback({ data: [] });
              },
            });
          },
          columns: [
            {
              data: "item_name",
              defaultContent: "-",
              render: (d) =>
                String(d).charAt(0).toUpperCase() + String(d).slice(1),
            },
            { data: "qty", defaultContent: "0" },
            {
              data: "unit",
              defaultContent: "-",
              render: (d) =>
                String(d).charAt(0).toUpperCase() + String(d).slice(1),
            },
            {
              data: "category",
              defaultContent: "-",
              render: (d) =>
                String(d).charAt(0).toUpperCase() + String(d).slice(1),
            },
            {
              data: "expiry",
              defaultContent: "-",
              render: (d) =>
                d === "N/A" || d === "-"
                  ? "N/A"
                  : moment(d).format("YYYY-MM-DD"),
            },

            // --- UPDATED STATUS COLOR LOGIC ---
            {
              data: "status",
              defaultContent: "N/A",
              render: function (data) {
                let statusText = String(data).toUpperCase();

                if (statusText === "EXPIRED") {
                  return `<span style="color: #e74c3c; font-weight: 800;">${data}</span>`; // Red
                } else if (
                  statusText === "SOON" ||
                  statusText === "EXPIRING SOON"
                ) {
                  return `<span style="color: #f39c12; font-weight: 800;">${data}</span>`; // Yellow
                } else {
                  return `<span style="color: #27ae60; font-weight: 800;">${data}</span>`; // Green
                }
              },
            },

            // --- UPDATED DAYS LEFT COLOR LOGIC ---
            {
              data: "days_left",
              defaultContent: "N/A",
              render: function (data) {
                let days = parseInt(data);
                if (isNaN(days)) return data;

                if (days < 0) {
                  return `<span style="color: #e74c3c; font-weight: bold;">Expired ${Math.abs(days)} days ago</span>`;
                } else if (days <= 3) {
                  return `<span style="color: #f39c12; font-weight: bold;">${days} days left</span>`;
                } else {
                  return `<span style="color: #27ae60; font-weight: bold;">${days} days</span>`;
                }
              },
            },
          ],
        });
      }
    </script>
  </body>
</html>

